#! /usr/bin/python

import sys, re, os, string
from cStringIO import StringIO

try:
	import pwd
	username = pwd.getpwuid(os.getuid())[0]
except ImportError:
	username = os.getenv('USERNAME')

try:
	clfp = open(os.environ.get('CVSROOT', '') + '/CVSROOT/ChangeLog')
	changeLogPrev = string.join(clfp.readlines(), '')
	clfp.close();
except IOError:
	changeLogPrev = ''

commit = sys.stdin.read()

files = []
specs = sys.argv[1:][0]
specfiles = string.split(specs)
del specfiles[0]
for specfile in specfiles:
	file = string.split(specfile, ',')[0]
	files.append(file)

file_header = string.join(files, ',')

islog = 0
s = ''
for line in string.split(commit, '\n'):
	if re.match('Bug:|Problem:|Feature:|New:', line):
		islog = 1
		s = s + ('* %s (%s)' % (file_header, username)) + '\n'

	if re.match('^\s*$', line) is not None:
		islog = 0

	if islog:
		s = s + '\t' + line + '\n'

s = re.sub('\s*$', '\n\n', s)
s = s + changeLogPrev
try:
	clfp = open(os.environ.get('CVSROOT', '') + '/CVSROOT/ChangeLog', 'w')
	clfp.write(s)
except:
	print 'error writing to log file'
